// Soft Melanin MCP - Database Schema
// Using PostgreSQL (Neon) in production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Content Artifacts
// ============================================================================

model ContentArtifact {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Core identifiers
  platform String // linkedin_founder, linkedin_company, substack
  segment  String // overextended_professional, healing_high_achiever, creative_reclaimer

  // Content
  hook String
  body String

  // Framework mappings stored as JSON
  tripleS String // JSON: { stop, stay, share }
  soft    String // JSON: { separate, own, filter, thrive }

  // Hashtags and SEO
  hashtags String  // JSON array
  seoTags  String? // JSON array (optional, for Substack)

  // Visual generation
  visual String // JSON: { prompt, palette, quoteCardTextOptions }

  // Product mentions
  productMentions String? // JSON array (optional)

  // Growth optimization
  growth String // JSON: { bestPostingTimes, repurposingIdeas, abVariants }

  // QA validation
  qa String // JSON: { authenticityPass, brandVoicePass, etc. }

  // Generation context
  seedIdea     String?
  monthlyTheme String?

  // Relations
  scheduledPosts ScheduledPost[]

  // Indexes for efficient querying
  @@index([platform])
  @@index([segment])
  @@index([createdAt])
}

// ============================================================================
// Generation Sessions
// ============================================================================

model GenerationSession {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Input
  seedIdea     String
  monthlyTheme String?
  segments     String // JSON array of selected segments
  platforms    String // JSON array of selected platforms

  // Options
  includeProductMentions Boolean @default(false)
  generateABVariants     Boolean @default(false)

  // Output
  artifactIds String // JSON array of artifact IDs
  success     Boolean
  errors      String? // JSON array of errors
}

// ============================================================================
// Monthly Themes
// ============================================================================

model MonthlyTheme {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Theme details
  month       Int    // 1-12
  year        Int
  title       String
  description String
  keywords    String // JSON array

  // Active status
  isActive Boolean @default(false)

  @@unique([month, year])
}

// ============================================================================
// Seed Ideas Library
// ============================================================================

model SeedIdea {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Content
  idea     String
  category String? // optional categorization
  tags     String? // JSON array

  // Usage tracking
  usageCount Int     @default(0)
  lastUsedAt DateTime?
}

// ============================================================================
// Hashtag Performance (for optimization)
// ============================================================================

model HashtagPerformance {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  hashtag     String @unique
  category    String // primary, wellness, identity, business
  usageCount  Int    @default(0)

  // Performance metrics (to be populated from analytics)
  avgEngagement Float?
  avgReach      Float?
}

// ============================================================================
// Social Account Connections
// ============================================================================

model SocialAccount {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Platform info
  platform     String // linkedin, substack
  accountType  String // founder, company (for LinkedIn)
  accountName  String // Display name
  accountId    String // External platform ID

  // OAuth tokens (encrypted in production)
  accessToken  String
  refreshToken String?
  tokenExpiry  DateTime?

  // Connection status
  isActive     Boolean @default(true)
  lastSyncAt   DateTime?

  // Relations
  scheduledPosts ScheduledPost[]

  @@unique([platform, accountId])
  @@index([platform])
  @@index([isActive])
}

// ============================================================================
// Scheduled Posts
// ============================================================================

model ScheduledPost {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Content reference
  artifactId String
  artifact   ContentArtifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)

  // Social account
  socialAccountId String
  socialAccount   SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)

  // Scheduling
  scheduledFor DateTime
  timezone     String @default("America/New_York")

  // Status tracking
  status       String @default("pending") // pending, queued, posting, published, failed, cancelled
  publishedAt  DateTime?
  externalPostId String? // ID from the platform after publishing

  // Error handling
  lastError    String?
  retryCount   Int @default(0)
  maxRetries   Int @default(3)

  // Metadata
  notes        String?

  @@index([status])
  @@index([scheduledFor])
  @@index([artifactId])
  @@index([socialAccountId])
}

// ============================================================================
// Post History (for analytics)
// ============================================================================

model PostHistory {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // References
  scheduledPostId String?
  artifactId      String
  platform        String

  // External data
  externalPostId  String?
  externalUrl     String?

  // Engagement metrics (updated via webhook or polling)
  impressions     Int?
  likes           Int?
  comments        Int?
  shares          Int?
  clicks          Int?

  // Raw response from platform
  rawResponse     String? // JSON

  @@index([artifactId])
  @@index([platform])
  @@index([createdAt])
}
